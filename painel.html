<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Big Trato • Painel (CRM)</title>
  <style>
    :root{--bg:#0f1115;--card:#121822;--line:#1d2736;--muted:#9fb0c7;--accent:#00ff88}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e8f0ff;font:14px/1.45 Arial,system-ui}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line)}
    .btn{border:2px solid var(--accent);background:transparent;color:var(--accent);padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer;margin-left:6px}
    .btn:hover{background:rgba(0,255,136,.12)}
    .wrap{padding:16px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;text-align:left}
    th{background:#0e1420}
    tr:nth-child(even){background:#121822}
    select{padding:4px;border-radius:6px;border:1px solid var(--line);background:#0e1420;color:#e8f0ff}
    .actions{display:flex;gap:8px}
    .editar{border:1px solid var(--accent);color:#fff;background:#1d2736;padding:6px 10px;border-radius:6px;cursor:pointer}
    .delete{border:1px solid red;color:#fff;background:#330000;padding:6px 10px;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <strong>CRM — Orçamentos</strong>
    <div>
      <button class="btn" onclick="window.location.href='home.html'">Home</button>
    </div>
  </header>

  <div class="wrap">
    <input id="search" placeholder="Buscar por cliente...">
    <select id="statusFilter">
      <option value="">Todos os status</option>
      <option value="Pendente">Pendente</option>
      <option value="Aprovado">Aprovado</option>
      <option value="Negado">Negado</option>
      <option value="Serviço Concluído">Serviço Concluído</option>
    </select>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Cliente</th>
          <th>Criado em</th>
          <th>Total</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ===== CONFIG FIREBASE =====
    const firebaseConfig = {
      apiKey: "SUA_KEY",
      authDomain: "SEU_PROJETO.firebaseapp.com",
      projectId: "SEU_PROJETO",
      storageBucket: "SEU_PROJETO.appspot.com",
      messagingSenderId: "XXX",
      appId: "XXX"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tbody = document.getElementById("tbody");
    const search = document.getElementById("search");
    const statusFilter = document.getElementById("statusFilter");

    // ====== CARREGAR ORÇAMENTOS ======
    async function carregar(){
      tbody.innerHTML = "";
      const snap = await getDocs(collection(db,"quotes"));
      let rows = [];
      snap.forEach(docSnap=>{
        rows.push({...docSnap.data(), _id:docSnap.id});
      });

      // filtros
      const termo = search.value.toLowerCase();
      const filtro = statusFilter.value;
      rows = rows.filter(r=>
        (!termo || (r.cliente||"").toLowerCase().includes(termo)) &&
        (!filtro || r.status===filtro)
      );

      rows.forEach(q=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${q.id ?? ''}</td>
          <td>${q.cliente||'-'}</td>
        <td>${
  q.createdAt 
    ? new Date((q.createdAt.seconds || q.createdAt) * 1000).toLocaleString('pt-BR')
    : '-'
}</td>

          <td>R$ ${q.total||'-'}</td>
          <td>
            <select class="status">
              <option ${q.status==='Pendente'?'selected':''}>Pendente</option>
              <option ${q.status==='Aprovado'?'selected':''}>Aprovado</option>
              <option ${q.status==='Negado'?'selected':''}>Negado</option>
              <option ${q.status==='Serviço Concluído'?'selected':''}>Serviço Concluído</option>
            </select>
          </td>
          <td class="actions">
            <button class="editar">Editar no gerador</button>
            <button class="delete">x</button>
          </td>
        `;

        // alterar status
        tr.querySelector('.status').addEventListener('change', async(e)=>{
          try{
            await updateDoc(doc(db,"quotes",q._id),{status:e.target.value});
            console.log("Status atualizado:", e.target.value);
          }catch(err){alert("Erro ao atualizar status")}
        });

        // editar
        tr.querySelector('.editar').addEventListener('click',()=>{
          localStorage.setItem("bt_load_quote", JSON.stringify(q));
          window.location.href="Gerador de orçamentos.html";
        });

        // deletar
        tr.querySelector('.delete').addEventListener('click',async()=>{
          if(confirm("Excluir este orçamento?")){
            await deleteDoc(doc(db,"quotes",q._id));
            carregar();
          }
        });

        tbody.appendChild(tr);
      });
    }

    search.addEventListener('input',carregar);
    statusFilter.addEventListener('change',carregar);
    carregar();
  </script>
</body>
</html>

